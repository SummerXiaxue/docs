# ECS

## Lambda架构

Lambda架构主要由这几部分构成：数据源（Kafka），数据处理（Storm，Hadoop），服务数据库（Serving DB）。其中数据源和服务数据库是整个架构数据的入口和出口。数据处理则是分为在在线处理和离线处理两部分。

![雷鸟推荐架构链路图](https://summerxiaxue.gitee.io/static/image/Lambda.png)

Lambda架构的好处是：架构简单，很好的结合了离线批处理和实时流处理的优点，稳定且实时计算成本可控。

Lambda架构的维护成本高：需要同时维护实时处理和离线处理两套代码的同时还要保证两套处理结果保持一致

## Kappa架构

![雷鸟推荐架构链路图](https://summerxiaxue.gitee.io/static/image/Kappa.png)

Kappa架构优势：架构简单，避免了维护两套系统还需要保持结果一致的问题，也很好解决了数据订正问题。

Kappa架构存在问题：

1. 消息中间件缓存的数据量和回溯数据有性能瓶颈。通常算法需要过去180天的数据，如果都存在消息中间件，无疑有非常大的压力。同时，一次性回溯订正180天级别的数据，对实时计算的资源消耗也非常大。
2. 在实时数据处理时，遇到大量不同的实时流进行关联时，非常依赖实时计算系统的能力，很可能因为数据流先后顺序问题，导致数据丢失。

## Flink方案

|        |                 优点                 |      缺点            |
|  :----:  | :------------------------------- | :------------------ |
|        |1、架构简单   |1、实时、离线数据很难保持一致结果|
|  Lambda  |2、很好的结合了离线批处理和实时流处理的优点|2、需要维护两套系统|
|        |3、稳定且实时计算成本可控|             |
|        |4、离线数据易于订正 |           |
|        |1、只需要维护实时处理模块|1、强依赖消息中间件缓存能力|
|  Kappa |2、可以通过消息重放|2、实时数据处理时存在丢失数据可能|
|        |3、无需离线实时数据合并|           |

实现流批处理一体化，Flink采用的将流处理视为批处理的一种特殊形式。因此在内部维持了若干张张流表。通过缓存时间进行约束，限定在一个时间段内的数据组成的表，从而将实时流转为微批处理。

存在几个问题：

1. Flink的流表是放在内存中，不做持久化处理的。一旦任务发生异常，内存数据丢失，Flink是需要回溯上游消息流，从而转为Kappa的结构。
2.  数据窗口开的越大，内存成本越高。受限于成本，对大量数据处理仍然有可支持的物理空间上限。
3. 下游接收的通常都是处理结果，对于内存中的流表数据是无法直接访问的。这样无形中增加了开发成本。

## ECS模式架构

**实体**(Entity)：实体是一个普通的对象。通常，它只包含了一个独一无二的ID值，用来标记它是一个独立的对象。

**组件**(Component)：对象一个方面的数据，以及对象如何和世界进行交互。用来标记实体是否需要进行这一方面的处理，通常使用结构体，类或关联数组实现。

**系统**(System)：每个系统不间断地运行(就像每个系统运行在自己的私有线程上)，处理标记使用了该系统处理的组件的每个实体。

![雷鸟推荐架构链路图](https://summerxiaxue.gitee.io/static/image/ECS_DB.png)

schema的使用则依赖table注册系统。通过table注册系统，将一些具有相关含义的schema串联起来，形成table提供给业务使用。

1. 数据进入数仓后，数据会被Schema Register中注册的规则提取出来，产出一个个对应的schema。即对应DWD层。
2. 有了schema后，数据进入处理加工逻辑。即System部分。这里需要针对实时和离线数仓分别产出对应的加工代码，并执行具体的加工。此处对应的是DWS层。
3. 最后，将加工后产出的schema和table Register系统结合，产出最终的ADS层的数据。
数据处理过程拆分成：数据声明（Schema Register，Table Register），数据处理（System）和结果拼接（Table Creater）三个流程。在这三个过程中，将Flink、Max Compute视为计算资源，将整体数据加工处理的逻辑独立在底层中间件之上，与开发环境解耦。从而实现工程化的管理数据仓库里的数据和加工过程。

存在问题：实时数据和离线数据是不互通的。如果统计过去180天UV总数时，需要离线和实时数据合并去重的处理就会遇到麻烦。